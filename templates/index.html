<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Leads und Kundenverwaltung</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="/static/css/main.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
</head>
<body>
    <div class="container mt-5">
        <h1 class="text-center">Control your Pipeline</h1>
        <button id="show-form-btn" class="btn btn-primary mt-3" onclick="toggleForm()">Add Lead</button>
        <form id="add-lead-form" method="POST" action="{{ url_for('add_lead') }}" style="display:none;" class="mt-3">
            <div class="form-group">
                <label for="first_name">First Name:</label>
                <input type="text" name="first_name" class="form-control">
            </div>
            <div class="form-group">
                <label for="last_name">Last Name:</label>
                <input type="text" name="last_name" class="form-control">
            </div>
            <div class="form-group">
                <label for="phone">Phone:</label>
                <input type="text" name="phone" class="form-control">
            </div>
            <div class="form-group">
                <label for="email">Email:</label>
                <input type="email" name="email" class="form-control">
            </div>
            <div class="form-group">
                <label for="status">Status:</label>
            <select name="status" class="form-control">
        
            <option value="1. Infogespräch fehlt noch">1. Infogespräch fehlt noch</option>
            <option value="2. Infogespräch geführt, EB fehlt">2. Infogespräch geführt, EB fehlt</option>
            <option value="3. Infogespräch geführt, warten auf SA Erlaubnis">3. Infogespräch geführt, warten auf SA Erlaubnis</option>
            <option value="4. SA kann geschalten werden">4. SA kann geschalten werden</option>
            <option value="5. SA geschalten, warten auf PV">5. SA geschalten, warten auf PV</option>
            <option value="6. PV vorgestellt, warten auf Feedback">6. PV vorgestellt, warten auf Feedback</option>
            <option value="7. PV akzeptiert, warten auf Vertrag">7. PV akzeptiert, warten auf Vertrag</option>
            <option value="8. Vertrag an Kunden gesendet">8. Vertrag an Kunden gesendet</option>
            <option value="9. Warten auf Reisedaten">9. Warten auf Reisedaten</option>
            <option value="10. Warten auf Anreise">10. Warten auf Anreise</option>
            <option value="11. Anreise erfolgt">11. Anreise erfolgt</option>
        </select>
    </div>
    <button type="submit" class="btn btn-success">Save</button>
</form>
<table id="leads-table" class="table table-striped mt-3">

    
    <label for="sort-by">Sort by:</label>
        <a href="{{ url_for('index', sort_by='id') }}">ID</a>
        <a href="{{ url_for('index', sort_by='last_name') }}">Nachname</a>
        <a href="{{ url_for('index', sort_by='status') }}">Status</a>


        

        

    
   
        <thead>
            <tr>
                <th onclick="sortTable(0)">ID</th>
                <th onclick="sortTable(1)">Vorname</th>
                <th onclick="sortTable(2)">Nachname</th>
                <th>Phone</th>
                <th>Email</th>
                <th onclick="sortTable(3)">Status</th>
                <th scope="col">Hinzugefügt am</th>
                <th scope="col">Zuletzt geändert</th>
                <th></th>
            </tr>
        </thead>
        <tbody>
            {% for lead in leads %}
            <tr>
                <td>{{ lead.id }}</td>
                <td>{{ lead.first_name }}</td>
                <td>{{ lead.last_name }}</td>
                <td>{{ lead.phone }}</td>
                <td>{{ lead.email }}</td>
                <td>{{ lead.status }}</td>
                <td>{{ lead.created_at.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                <td>{{ lead.last_changed.strftime('%d.%m.%Y %H:%M') }}</td>
                <!-- ... other table cells ... -->
                    
                        <td>
                            <div class="dropdown">
                                <button class="btn btn-danger dropdown-toggle" type="button" id="deleteMenu" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                    Delete
                                </button>
                                <div class="dropdown-menu" aria-labelledby="deleteMenu">
                                    <button class="dropdown-item" onclick="deleteLead('{{ lead.id }}', 'mistake')">Delete because of mistake</button>
                                    <button class="dropdown-item" onclick="deleteLead('{{ lead.id }}', 'not_convert')">Delete because customer will not convert</button>
                                    <div class="dropdown-divider"></div>
                                    <div class="dropdown-header">Reason for not converting:</div>
                                    {% for i in range(1, 8) %}
                                    <button class="dropdown-item" onclick="deleteLeadWithReason('{{ lead.id }}', 'reason_{{ i }}')">Reason {{ i }}</button>
                                    {% endfor %}
                                </div>
                            </div>
                            
                            <button onclick="changeStatus('{{ lead.id }}')">Next Stage</button>
                        </td>

                </tr>
                {% endfor %}
            </tbody>
        </table>
    
        <script>
            function toggleForm() {
                var form = document.getElementById('add-lead-form');
                if (form.style.display === 'none') {
                    form.style.display = 'block';
                } else {
                    form.style.display = 'none';
                }
            }
    
            function sortTable(n) {
                var table, rows, switching, i, x, y, shouldSwitch, dir, switchcount = 0;
                table = document.getElementById("leads-table");
                switching = true;
                // Set the sorting direction to ascending:
                dir = "asc";
                /* Make a loop that will continue until
                no switching has been done: */
                while (switching) {
                    // Start by saying: no switching is done:
                    switching = false;
                    rows = table.rows;
                    /* Loop through all table rows (except the
                    first, which contains table headers): */
                    for (i = 1; i < (rows.length - 1); i++) {
                        // Start by saying there should be no switching:
                        shouldSwitch = false;
                        /* Get the two elements you want to compare,
                        one from current row and one from the next: */
                        x = rows[i].getElementsByTagName("TD")[n];
                        y = rows[i + 1].getElementsByTagName("TD")[n];
                        /* Check if the two rows should switch place,
                        based on the direction, asc or desc: */
                        if (dir == "asc") {
                            if (x.innerHTML.toLowerCase() > y.innerHTML.toLowerCase()) {
                                // If so, mark as a switch and break the loop:
                                shouldSwitch = true;
                                break;
                            }
                        } else if (dir == "desc") {
                            if (x.innerHTML.toLowerCase() < y.innerHTML.toLowerCase()) {
                                // If so, mark as a switch and break the loop:
                                shouldSwitch = true;
                                break;
                            }
                        }
                    }
                    if (shouldSwitch) {
                        /* If a switch has been marked, make the switch
                        and mark that a switch has been done: */
                        rows[i].parentNode.insertBefore(rows[i + 1], rows[i]);
                        switching = true;
                        // Each time a switch is done, increase switchcount by 1:
                        switchcount++;
                    } else {
                        /* If no switching has been done AND the direction is "asc",
                        set the direction to "desc" and run the while loop again. */
                        if (switchcount == 0 && dir == "asc") {
                            dir = "desc";
                            switching = true;
                        }
                    }
                }
            }

            function changeStatus(id) {
                $.ajax({
                url: "/change_status/" + id,
                type: "POST",
                success: function() {
                location.reload();
            },
                error: function() {
                alert("Error changing the status. Please try again.");
            }
    });
}

            function deleteLead(leadId, reason) {
                if (confirm('Are you sure you want to delete this lead?')) {
                    $.ajax({
                        url: '/delete_lead/' + leadId + '/' + reason,
                        type: 'POST',
                        success: function () {
                            location.reload();
                        },
                        error: function () {
                            alert('Error deleting the lead. Please try again.');
                        }
                    });
                }
            }

            function deleteLeadWithReason(leadId, reason) {
                if (confirm('Are you sure you want to delete this lead with reason ' + reason + '?')) {
                    $.ajax({
                        url: '/delete_lead/' + leadId + '/' + reason,
                        type: 'POST',
                        success: function () {
                            location.reload();
                        },
                        error: function () {
                            alert('Error deleting the lead. Please try again.');
                        }
                    });
                }
            }


        </script>
        <a href="{{ bk_link }}">{{ bk_link_text }}</a>
    </body>
    </html>
